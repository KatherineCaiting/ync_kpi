package com.ync365.oa.service.efficiencyResult;

import java.math.BigDecimal;
import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.List;

import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Predicate;
import javax.persistence.criteria.Root;
import javax.transaction.Transactional;

import org.apache.commons.lang3.StringUtils;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.jpa.domain.Specification;
import org.springframework.stereotype.Component;

import com.ync365.oa.entity.Efficiency;
import com.ync365.oa.entity.EfficiencyResult;
import com.ync365.oa.entity.Employe;
import com.ync365.oa.entity.SatisfactionResult;
import com.ync365.oa.query.EfficiencyQuery;
import com.ync365.oa.query.EfficiencyResultQuery;
import com.ync365.oa.query.EmployeQuery;
import com.ync365.oa.query.SatisfactionResultQuery;
import com.ync365.oa.repository.EfficiencyDao;
import com.ync365.oa.repository.EfficiencyResultDao;
import com.ync365.oa.repository.EmployeDao;
import com.ync365.oa.service.efficiency.EfficiencyService;
import com.ync365.oa.service.employe.EmployeService;
import com.ync365.oa.service.properties.PropertiesService;

@Component
@Transactional
public class EfficiencyResultService {
	
	private Logger log= LoggerFactory.getLogger(EfficiencyResult.class);
	
	private static final int h=9;//每天标准出勤工时

	@Autowired
	private EfficiencyResultDao  efficiencyResultDao;
	
	@Autowired
	private EfficiencyDao efficiencyDao;
	
	@Autowired
	private EmployeService employeService;
	
	@Autowired
	private EfficiencyService efficiencyService; 
	
	@Autowired
	private EmployeDao employeDao; 
	/***
	 * 插入月度绩效
	 */
	public void add(EfficiencyResult efficiencyResult){
		 efficiencyResultDao.save(efficiencyResult);
	}
	/**
	 * 查询单个
	 * */
	public EfficiencyResult findOne(Long id){
		return efficiencyResultDao.findOne(id);
	}
	
	/***
	 *  查询月度绩效
	 * @return
	 */
	public Page<EfficiencyResult> find(final EfficiencyResultQuery erq){
		Specification<EfficiencyResult> sp=new Specification<EfficiencyResult>() {

			@Override
			public Predicate toPredicate(Root<EfficiencyResult> root,
					CriteriaQuery<?> query, CriteriaBuilder cb) {
				// TODO Auto-generated method stub
				List<Predicate> list=new ArrayList<>();
				
				if(StringUtils.isNotEmpty(erq.getEmployeName())){
					list.add(cb.equal(root.get("employeName").as(String.class),erq.getEmployeName()));
				}
				if(StringUtils.isNotEmpty(erq.getEmployeCode())){
					list.add(cb.equal(root.get("employeCode").as(String.class), erq.getEmployeCode()));
				}
				if(erq.getProjectCount()!=null){
					list.add(cb.equal(root.get("projectCount").as(Integer.class), erq.getProjectCount()));
				}
				if(StringUtils.isNotEmpty(erq.getDepartmentName())){
					list.add(cb.equal(root.get("departmentName").as(String.class), erq.getDepartmentName()));
				}
				if(erq.getActualHours()!=null){
					list.add(cb.equal(root.get("actualHours").as(Integer.class), erq.getActualHours()));
				}
			  if (erq.getCreateTime() != null) {
                    SimpleDateFormat f = new SimpleDateFormat("yyyy-MM");
                    list.add(cb.equal(cb.substring(root.get("createTime").as(String.class), 1, 7),
                            f.format(erq.getCreateTime())));
                }
				Predicate[] ps=new Predicate[list.size()];
				query.where(cb.and(list.toArray(ps)));
				if (StringUtils.isNotEmpty(erq.getSort())) {
                    query.orderBy(cb.desc(root.get(erq.getSort())));
                }
				return query.getGroupRestriction();
			}
		};
		PageRequest pageRequest =null;
		if (erq.getPageIndex() != null && erq.getPageSize() != null) {
            pageRequest = new PageRequest(erq.getPageIndex(),erq.getPageSize());
        }
		Page<EfficiencyResult> pages=null;
		pages=efficiencyResultDao.findAll(sp,pageRequest);
		return pages;
	}
	
	/***
	 * 查询某个月该名员工的效能
	 */
	
	public List<Efficiency> findEmployeEfficiency(final EfficiencyQuery eq){
		Specification<Efficiency> sp=new Specification<Efficiency>() {

			@Override
			public Predicate toPredicate(Root<Efficiency> root,
					CriteriaQuery<?> query, CriteriaBuilder cb) {
				// TODO Auto-generated method stub
				List<Predicate> list=new ArrayList<>();
				if(StringUtils.isNotEmpty(eq.getEmployeCode())){
					list.add(cb.equal(root.get("employeCode").as(String.class), eq.getEmployeCode()));
				}
				if(eq.getCreateTime()!=null){
					SimpleDateFormat f=new SimpleDateFormat("yyyy-MM");
					list.add(cb.equal(cb.substring(root.get("createTime").as(String.class),1,7), f.format(eq.getCreateTime())));
				}
				Predicate[] ps=new Predicate[list.size()];
				query.where(cb.and(list.toArray(ps)));
				return query.getGroupRestriction();
			}
		};
		
		return efficiencyDao.findAll(sp);
		 
	}
	
	/***
	 * 查询项目下面的员工效能
	 * 
	 */
	public List<Efficiency> selectEfficiencyByProjectId(final Integer id){
		Specification<Efficiency> sp=new Specification<Efficiency>() {

			@Override
			public Predicate toPredicate(Root<Efficiency> root,
					CriteriaQuery<?> query, CriteriaBuilder cb) {
				// TODO Auto-generated method stub
				if(id!=null){
					Predicate p1=cb.equal(root.get("employeCode").as(Integer.class), id);
					query.where(p1);
				}				
				return query.getRestriction();
			}
		};
		List<Efficiency> efficiencyList=efficiencyDao.findAll(sp);
		return efficiencyList;
	}
	
	/****
	 * 定时任务方法
	 */
	public void calcEfficiencyResult(){
		/*当前时间*/
		Calendar cal = Calendar.getInstance();
		cal.add(Calendar.MONTH, -1);
		Date calDate = cal.getTime();
		/**/
		List<EfficiencyResult> list=new ArrayList<EfficiencyResult>();
		EfficiencyResultQuery efficiencyResultQuery=new EfficiencyResultQuery();
		efficiencyResultQuery.setCreateTime(calDate);
		
		/*查找的方法*/
		EmployeQuery employeQuery=new EmployeQuery();
		List<Employe> es=employeService.find(employeQuery).getContent();
		for(Employe e:es){
			List<Efficiency> efs=efficiencyService.findEfficiencyByEmployeCodeAndTime(e.getCode(), calDate);
			EfficiencyResult efficiencyResult= calcEfficiency(efs);
			add(efficiencyResult);
		}
	}
	/**
     * 算分方法
     * */
    private EfficiencyResult calcEfficiency(List<Efficiency> efs){
    	Integer planHoursTotal=0;//计划工时
    	Integer outputHoursTotal=0;//产出工时
    	Integer basicHoursTotal=0;//标准工时
    	Integer actualHoursTotal=0;//实际工时
    	
    	Double loadRate;//负荷率
    	Double efficiencyPercentage;//效率
    	Integer efficiencyTotalScore;//总分
    	
    	//计算月份
    	Calendar cal=Calendar.getInstance();
    	cal.setTime(efs.get(0).getCreateTime());
    	int month=cal.get(Calendar.MONTH)+1;
    	System.out.println("月份"+month);
    	
    	/*
    	 * 每月标准的出勤日
    	 * 1,4,6,8,11月上21天班 2月17天班 3，9月22天班 5月20天班 7,12月23天班 10月18
    	 * 计算标准工时
    	 * */
    	if(month == 1|| month ==4 ||month == 6 ||month==8 ||month ==11){
    		basicHoursTotal= 21*h;
    	}else if(month == 2){
    		basicHoursTotal=17*h;
    	}else if(month == 3 || month ==9){
    		basicHoursTotal=22*h;
    	}else if(month ==5){
    		basicHoursTotal=20*h;
    	}else if(month ==7|| month ==12){
    		basicHoursTotal=23*h;
    	}else{
    		basicHoursTotal=18*h;
    	}
    	
    	/*计算计划工时总和，产出工时总和，实际工时综合*/
    	for(Efficiency e:efs){
    		planHoursTotal += e.getPlanHours();
    		outputHoursTotal +=e.getOutputHours();
    		actualHoursTotal +=e.getActualHours();
    	}
    	
    	/***
    	 * 计算负荷率 效率 总分
    	 */
    	BigDecimal o=new BigDecimal(outputHoursTotal.toString());
    	BigDecimal b=new BigDecimal(basicHoursTotal.toString());
    	BigDecimal p=new BigDecimal(planHoursTotal.toString());
    	//负荷率计算：产出工时/标准工时    效率计算：计划工时/产出工时  总分：
    	loadRate =o.divide(b,3,BigDecimal.ROUND_HALF_UP).doubleValue();  //精确到小数点后三位
    	efficiencyPercentage=p.divide(o,3,BigDecimal.ROUND_HALF_UP).doubleValue();
    	
    	BigDecimal le=new BigDecimal(Double.toString(loadRate+efficiencyPercentage));
    	BigDecimal s=new BigDecimal(2);
    	//求出平均数
    	Double d=le.divide(s,3,BigDecimal.ROUND_HALF_UP).doubleValue();//效率和负荷率的平均数
    	BigDecimal da=new BigDecimal(Double.toString(d));
    	BigDecimal es=null;
    	if(PropertiesService.EFFICIENCY_SCORE!=null){
    		 es=new BigDecimal((PropertiesService.EFFICIENCY_SCORE).toString());
    	}
    	if(PropertiesService.EFFICIENCY_SCORE == null || PropertiesService.EFFICIENCY_SCORE == 0){
    		efficiencyTotalScore=d.intValue();
    	}else{
    		efficiencyTotalScore=(int) da.multiply(es).doubleValue();
    	}
    	
    	/*System.out.println("计划工时总长"+planHoursTotal);
    	System.out.println("产出工时总长"+outputHoursTotal);
    	System.out.println("标准工时总长"+basicHoursTotal);
    	
    	System.out.println("负荷率"+loadRate);
    	System.out.println("效率"+efficiencyPercentage);
    	System.out.println("总分"+efficiencyTotalScore);*/
    	
    	EfficiencyResult efficiencyResult=new EfficiencyResult();
    	efficiencyResult.setEmployeCode(efs.get(0).getEmployeCode());
    	efficiencyResult.setEmployeName(efs.get(0).getEmployeName());
    	efficiencyResult.setDepartmentId(efs.get(0).getDepartmentId());
    	efficiencyResult.setDepartmentName(efs.get(0).getDepartmentName());
    	efficiencyResult.setProjectCount(efs.size());
    	efficiencyResult.setPlanHours(planHoursTotal);
    	efficiencyResult.setActualHours(actualHoursTotal);
    	efficiencyResult.setOutputHours(outputHoursTotal);
    	efficiencyResult.setBasicHours(basicHoursTotal);
    	efficiencyResult.setLoadRate(loadRate);
    	efficiencyResult.setEfficiencyPercentage(efficiencyPercentage);
    	efficiencyResult.setEfficiencyTotalScore(efficiencyTotalScore);
    	efficiencyResult.setCreateTime(efs.get(0).getPlanBeginTime());//暂时按照计划开始时间作为月度绩效中的创建时间
    	
    	return efficiencyResult;
    }
    
    /***
     *根据员工的id和时间查找月度效能 
     */
    public EfficiencyResult findEfficiencyResult(Long id , Date date){
    	Employe e=employeDao.findOne(id);
    	EfficiencyResultQuery q=new EfficiencyResultQuery();
    	q.setEmployeCode(e.getCode());
    	q.setCreateTime(date);
    	Specification<EfficiencyResult> sp=buildSpecification(q);
    	EfficiencyResult efficiencyResult=efficiencyResultDao.findOne(sp);
    	return efficiencyResult;
    }
    /***
     * 查询处理条件
     */
    private Specification<EfficiencyResult> buildSpecification(final EfficiencyResultQuery q) {
		Specification<EfficiencyResult> sp = new Specification<EfficiencyResult>() {

			@Override
			public Predicate toPredicate(Root<EfficiencyResult> root, CriteriaQuery<?> query, CriteriaBuilder cb) {
				List<Predicate> list = new ArrayList<>();
				
				if (q.getCreateTime() != null) {
					SimpleDateFormat f = new SimpleDateFormat("yyyy-MM");
					list.add(cb.equal(cb.substring(root.get("createTime").as(String.class), 1, 7),
							f.format(q.getCreateTime())));
				}
				if (StringUtils.isNotEmpty(q.getEmployeCode())) {
					list.add(cb.equal(root.get("employeCode").as(String.class),
							q.getEmployeCode()));
				}
				
				Predicate[] ps = new Predicate[list.size()];
				query.where(cb.and(list.toArray(ps)));
				return query.getGroupRestriction();
			}
		};
		return sp;
	}
}
