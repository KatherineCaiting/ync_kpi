package com.ync365.oa.service.specialty;


import java.text.SimpleDateFormat;
import java.util.ArrayList;
import java.util.Calendar;
import java.util.Date;
import java.util.List;

import javax.persistence.criteria.CriteriaBuilder;
import javax.persistence.criteria.CriteriaQuery;
import javax.persistence.criteria.Predicate;
import javax.persistence.criteria.Root;

import org.junit.Test;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.data.jpa.domain.Specification;

import com.ync365.oa.entity.Employe;
import com.ync365.oa.entity.Specialty;
import com.ync365.oa.entity.SpecialtyJX;
import com.ync365.oa.repository.BaseTest;
import com.ync365.oa.repository.EmployeDao;
import com.ync365.oa.repository.SpecialtyDao;
import com.ync365.oa.repository.SpecialtyJXDao;

public class SpecialtyJXServiceTest extends BaseTest{
	@Autowired
	private SpecialtyJXDao specialtyJXDao;
	@Autowired
	private SpecialtyDao specialtyDao;
	@Autowired
	private EmployeDao employeDao;
	@Test
	public void testGetSpecialtyJX(){
		//List<SpecialtyJX> list = specialtyJXDao.findAll(spec);
		List<SpecialtyJX> list = new ArrayList<SpecialtyJX>();
		SpecialtyJX jx1 = new SpecialtyJX();		
		SpecialtyJX jx2 = new SpecialtyJX();
		SpecialtyJX jx3 = new SpecialtyJX();
		SpecialtyJX jx4 = new SpecialtyJX();
		jx1.setScore(4d);
		jx2.setScore(5d);
		jx3.setScore(7d);
		jx4.setScore(8d);
		list.add(jx1);
		list.add(jx2);
		list.add(jx3);
		list.add(jx4);
		if(list!=null&&list.size()>0){
			Double totalScore = 0d;
			for (SpecialtyJX specialtyJX : list) {
				//计算某个被评价人的专业性总分
				totalScore += specialtyJX.getScore();				
			}
			SpecialtyJX specJX = list.get(2);
			specJX.setTotalScore(totalScore);
			System.out.println("小张的专业评价总分为：=============="+specJX.getTotalScore());
		}
		
	}
	@Test
	public void addSpecialtyJXList(){
			
		Specification<Employe> spec1 = new Specification<Employe>() {
			@Override
			public Predicate toPredicate(Root<Employe> root,
					CriteriaQuery<?> query, CriteriaBuilder cb) {				
				return cb.and(cb.equal(root.get("departmentId"),2));
			}			
		};		
		List<Employe> empList = employeDao.findAll(spec1);		
		
		List<SpecialtyJX> specialtyJXList = new ArrayList<SpecialtyJX>();
		if(empList!=null&&empList.size()>0){			
			for (Employe employe2 : empList) {
				SpecialtyJX jx1 = new SpecialtyJX();
				jx1.setDepartmentId(employe2.getDepartmentId());
				jx1.setDepartmentName(employe2.getDepartmentName());
				jx1.setBeEvaluatedId(employe2.getId());
				jx1.setBeEvaluatedName(employe2.getName());	
				specialtyJXList.add(jx1);
			}
		}		
		//得到该部门下的所有专业性
		Specification<Specialty> spec2 = new Specification<Specialty>() {
			@Override
			public Predicate toPredicate(Root<Specialty> root,CriteriaQuery<?> query, CriteriaBuilder cb) {
				List<Predicate> predList = new ArrayList<Predicate>();
				predList.add(cb.and(cb.equal(root.get("departmentId"), 2)));				
				
                SimpleDateFormat f = new SimpleDateFormat("yyyy-MM");
                predList.add(cb.equal(cb.substring(root.get("createTime").as(String.class), 1, 7),
                        f.format(new Date("2015/12/01"))));	            	
				Predicate[] ps = new Predicate[predList.size()];
                query.where(cb.and(predList.toArray(ps))); 
                query.orderBy(cb.desc(cb.substring(root.get("createTime").as(String.class), 1, 7)));
                return query.getGroupRestriction();
			}			
		};		
		List<Specialty> specialtyList = specialtyDao.findAll(spec2);
		//组装数据
		int times = 1;
		for (Specialty specialty : specialtyList) {
			for (SpecialtyJX specialtyJX : specialtyJXList) {
				if(times==1){//第一次执行外循环
					specialtyJX.setSpecialtyId(specialty.getId());
					specialtyJX.setSpecialtyName(specialty.getName());
					specialtyJX.setCreateTime(specialty.getCreateTime());
					specialtyJXDao.save(specialtyJX);					
				}else{//第二次执行外循环
					SpecialtyJX specialtyJX2 = new SpecialtyJX();					
					specialtyJX2.setDepartmentId(specialtyJX.getDepartmentId());
					specialtyJX2.setDepartmentName(specialtyJX.getDepartmentName());					
					specialtyJX2.setBeEvaluatedId(specialtyJX.getBeEvaluatedId());
					specialtyJX2.setBeEvaluatedName(specialtyJX.getBeEvaluatedName());
					specialtyJX2.setSpecialtyId(specialty.getId());
					specialtyJX2.setSpecialtyName(specialty.getName());
					specialtyJX2.setCreateTime(specialty.getCreateTime());
					specialtyJXDao.save(specialtyJX2);					
				}				
			}
			times++;
		}
		
		for (SpecialtyJX specialtyJX : specialtyJXList) {
			System.out.println("============"+specialtyJX.getBeEvaluatedName()+"的专业性："+specialtyJX.getSpecialtyName()+"的得分是："+specialtyJX.getScore());
		}
	}
	@Test
	public void getEmployesByDepartmentId(){
		Specification<Employe> spec = new Specification<Employe>() {
			@Override
			public Predicate toPredicate(Root<Employe> root,
					CriteriaQuery<?> query, CriteriaBuilder cb) {				
				return cb.and(cb.equal(root.get("departmentId"),2));
			}			
		};		
		List<Employe> empList = employeDao.findAll(spec);
		for (Employe employe : empList) {
			System.out.println(employe.getName()+"==========的部门是："+employe.getDepartmentName());
		}		
	}
	@Test
	public void testInit(){
		// 得到所有部门的所有专业性
		List<Specialty> specialtyList = (List<Specialty>) specialtyDao
				.findAll();
		// 得到所有员工
		List<Employe> employeList = (List<Employe>) employeDao.findAll();
		if (specialtyList != null && specialtyList.size() > 0) {
			for (Specialty specialty : specialtyList) {
				for (Employe employe : employeList) {
					if (employe.getDepartmentId() == specialty
							.getDepartmentId()) {
						SpecialtyJX specialtyJX = new SpecialtyJX();
						specialtyJX.setDepartmentId(employe.getDepartmentId());
						specialtyJX.setDepartmentName(employe
								.getDepartmentName());
						specialtyJX.setSpecialtyId(specialty.getId());
						specialtyJX.setSpecialtyName(specialty.getName());
						specialtyJX.setBeEvaluatedId(employe.getId());
						specialtyJX.setBeEvaluatedName(employe.getName());						
						specialtyJX.setCreateTime(new Date());
						specialtyJXDao.save(specialtyJX);
					}
				}
			}
		}
	}
}
